@model SupportU.Application.DTOs.UsuarioDTO
@{
    Func<string, string> t = key =>
    {
        var translations = ViewData["Translations"] as System.Collections.Generic.Dictionary<string, string>
            ?? new System.Collections.Generic.Dictionary<string, string>(System.StringComparer.OrdinalIgnoreCase);
        return translations.TryGetValue(key, out var val) ? val : key;
    };
    ViewData["Title"] = t("Usuario_Create_Title");
    var translations = ViewData["Translations"] as System.Collections.Generic.Dictionary<string, string>
        ?? new System.Collections.Generic.Dictionary<string, string>(System.StringComparer.OrdinalIgnoreCase);
}

<section class="vh-100 d-flex align-items-center" style="background: linear-gradient(135deg,#f6f9ff 0%,#eef6ff 100%);">
    <div class="container" data-aos="fade-up">
        <div class="row justify-content-center">
            <div class="col-lg-8 text-center">
                <div class="hero-badge mb-3"><i class="bi bi-person-plus-fill"></i> <span>@t("Usuario_Management")</span></div>
                <h1 class="hero-title mb-2">@t("Usuario_Create_Header")</h1>
                <p class="hero-description mb-4 text-muted">@t("Usuario_Create_Description")</p>
            </div>
        </div>

        <div class="row justify-content-center mt-4">
            <div class="col-lg-7">
                <div class="card shadow-lg border-0 rounded-4 overflow-hidden">
                    <div class="row g-0">
                        <div class="col-md-5 d-none d-md-flex align-items-center justify-content-center" style="background: linear-gradient(180deg,#0d6efd 0%,#3aa0ff 100%);">
                            <div class="text-center text-white p-4 w-100">
                                <img src="~/assets/img/supportU.jpg" alt="SupportU" style="height:48px; margin-bottom:18px;" />
                                <h3 class="h5 mb-2">@t("Usuario_Create_Header")</h3>
                                <p class="small mb-0 opacity-85">@t("Usuario_Management")</p>
                            </div>
                        </div>

                        <div class="col-md-7">
                            <div class="card-body p-4 p-md-5">
                                @* Mostrar errores del servidor *@
                                @if (!ViewData.ModelState.IsValid)
                                {
                                    <div class="alert alert-danger" id="serverErrors">
                                        <ul class="mb-0">
                                            @foreach (var entry in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                                            {
                                                var key = entry.ErrorMessage;
                                                var text = translations.ContainsKey(key) ? translations[key] : (translations.ContainsKey(key + "_Text") ? translations[key + "_Text"] : key);
                                                <li>@text</li>
                                            }
                                        </ul>
                                    </div>
                                }

                                <form asp-action="Create" method="post" id="frmCreateUsuario" novalidate>
                                    @Html.AntiForgeryToken()

                                    <input type="hidden" asp-for="UsuarioId" />
                                    <input type="hidden" asp-for="FechaCreacion" value="@(Model?.FechaCreacion == default ? DateTime.UtcNow.ToString("o") : Model.FechaCreacion.ToString("o"))" />
                                    <input type="hidden" name="Rol" value="Cliente" />
                                    <input type="hidden" name="Activo" value="true" />

                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">@t("Label_Email")</label>
                                        <div class="input-group shadow-sm">
                                            <span class="input-group-text bg-white border-end-0"><i class="bi bi-envelope"></i></span>
                                            <input name="Email" id="Email" class="form-control border-start-0" value="@Model?.Email" autocomplete="email" placeholder="usuario@ejemplo.com" />
                                        </div>
                                        <div class="text-danger small mt-1" id="errEmail" style="display:none"></div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label fw-semibold">@t("Label_Nombre")</label>
                                            <div class="input-group shadow-sm">
                                                <span class="input-group-text bg-white border-end-0"><i class="bi bi-person"></i></span>
                                                <input name="Nombre" id="Nombre" class="form-control border-start-0" value="@Model?.Nombre" autocomplete="given-name" placeholder="@t("Label_Nombre")" />
                                            </div>
                                            <div class="text-danger small mt-1" id="errNombre" style="display:none"></div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label fw-semibold">@t("Label_Apellidos")</label>
                                            <div class="input-group shadow-sm">
                                                <span class="input-group-text bg-white border-end-0"><i class="bi bi-person-badge"></i></span>
                                                <input name="Apellidos" id="Apellidos" class="form-control border-start-0" value="@Model?.Apellidos" autocomplete="family-name" placeholder="@t("Label_Apellidos")" />
                                            </div>
                                            <div class="text-danger small mt-1" id="errApellidos" style="display:none"></div>
                                        </div>
                                    </div>

                                    <div class="mb-3 position-relative">
                                        <label class="form-label fw-semibold">@t("Label_Password")</label>
                                        <div class="input-group shadow-sm">
                                            <input name="PasswordHash" id="PasswordHash" type="password" class="form-control" autocomplete="new-password" placeholder="••••••••" />
                                            <button class="btn btn-outline-secondary" type="button" id="btnTogglePassword" title="@t("Btn_ShowPassword")">
                                                <i id="iconToggle" class="bi bi-eye"></i>
                                            </button>
                                        </div>
                                        <div class="text-danger small mt-1" id="errPasswordHash" style="display:none"></div>
                                        <div class="form-text mt-1">@t("Help_Password")</div>
                                    </div>

                                    <div class="d-flex gap-2 justify-content-end mt-4">
                                        <button type="submit" id="btnGuardar" class="btn btn-primary btn-lg">@t("Btn_SaveU")</button>
                                        <a asp-controller="Login" asp-action="Index" class="btn btn-outline-secondary btn-lg">@t("Btn_CancelU")</a>
                                    </div>
                                </form>

                                <hr class="my-4" />

                                <div class="text-center small text-muted">
                                    @t("Footer_AllRightsReserved")
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="text-center mt-3 small text-muted">
                    <span>@t("Footer_Course")</span>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        (function () {
            // Helpers
            function translate(key, fallback) {
                // Intentamos leer del DOM las traducciones si están expuestas en ViewData (no obligatorio)
                // Fallback a segundo parámetro
                return fallback || key;
            }

            function isEmailValid(email) {
                if (typeof email !== 'string') return false;
                var s = email.trim();
                if (!s) return false;
                var re = new RegExp('^[^\\s\\u0040]+\\u0040[^\\s\\u0040]+\\.[^\\s\\u0040]+$');
                return re.test(s);
            }

            function showErr(id, msg) {
                var el = $('#' + id);
                if (!msg) el.hide().text('');
                else el.show().text(msg);
            }

            function validateField(name, value) {
                if (name === 'Email') {
                    if (!value || !value.trim()) return translate('UsuarioValidation_EmailRequired', 'El correo es obligatorio');
                    if (!isEmailValid(value.trim())) return translate('UsuarioValidation_EmailInvalid', 'Formato de correo inválido');
                    return null;
                }
                if (name === 'Nombre') {
                    if (!value || !value.trim()) return translate('UsuarioValidation_NameRequired', 'El nombre es obligatorio');
                    return null;
                }
                if (name === 'Apellidos') {
                    if (!value || !value.trim()) return translate('UsuarioValidation_LastNameRequired', 'Los apellidos son obligatorios');
                    return null;
                }
                if (name === 'PasswordHash') {
                    if (!value || !value.trim()) return translate('UsuarioValidation_PasswordRequired', 'La contraseña es obligatoria');
                    return null;
                }
                return null;
            }

            var fields = ['Email', 'Nombre', 'Apellidos', 'PasswordHash'];
            fields.forEach(function (f) {
                $('#' + f).on('input blur change', function () {
                    var val = $(this).val();
                    var err = validateField(f, val);
                    showErr('err' + f, err);
                });
            });

            // Toggle ver/ocultar contraseña
            $('#btnTogglePassword').on('click', function () {
                var $pwd = $('#PasswordHash');
                var $icon = $('#iconToggle');
                if ($pwd.attr('type') === 'password') {
                    $pwd.attr('type', 'text');
                    $icon.removeClass('bi-eye').addClass('bi-eye-slash');
                    $(this).attr('title', translate('Btn_HidePassword', 'Ocultar contraseña'));
                } else {
                    $pwd.attr('type', 'password');
                    $icon.removeClass('bi-eye-slash').addClass('bi-eye');
                    $(this).attr('title', translate('Btn_ShowPassword', 'Mostrar contraseña'));
                }
            });

            // Submit: validación cliente antes de enviar
            $('#frmCreateUsuario').on('submit', function (e) {
                var hasError = false;
                fields.forEach(function (f) {
                    var val = $('#' + f).val();
                    var err = validateField(f, val);
                    showErr('err' + f, err);
                    if (err) hasError = true;
                });

                if (hasError) {
                    e.preventDefault();
                    var first = $('.text-danger:visible').first();
                    if (first.length) {
                        var related = first.prev('input, textarea');
                        if (related.length) related.focus();
                    }
                    return false;
                }
                return true;
            });

            // Mapear errores del servidor a campos visibles si existen
            $(function () {
                var msgs = $('#serverErrors ul li').map(function () { return $(this).text(); }).get();
                if (msgs.length === 0) return;
                msgs.forEach(function (msg) {
                    var lower = msg.toLowerCase();
                    if (lower.includes('correo') || lower.includes('email')) showErr('errEmail', msg);
                    else if (lower.includes('nombre')) showErr('errNombre', msg);
                    else if (lower.includes('apellidos')) showErr('errApellidos', msg);
                    else if (lower.includes('contraseña') || lower.includes('password')) showErr('errPasswordHash', msg);
                });
            });
        })();
    </script>

    @* Render TempData scripts outside the inline IIFE to avoid Razor parsing issues *@
    @if (TempData["ToastMessage"] != null)
    {
        @Html.Raw(TempData["ToastMessage"].ToString())
    }

    @if (TempData.Peek("ForgotLogs") != null)
    {
        @Html.Raw(TempData.Peek("ForgotLogs").ToString())
    }
}
